<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thumbnail Status Checker</title>
  <link rel="stylesheet" href="../base.css">
  <style>
    body {
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }
    .header {
      margin-bottom: 2rem;
    }
    .header h1 {
      margin: 0 0 0.5rem;
    }
    .back-link {
      color: var(--fg);
      opacity: 0.7;
      text-decoration: none;
    }
    .back-link:hover {
      opacity: 1;
      text-decoration: underline;
    }
    .status {
      margin: 2rem 0;
    }
    .summary {
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    .summary div {
      margin: 0.5rem 0;
    }
    .button {
      padding: 0.75rem 1.5rem;
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.1);
      color: var(--fg);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
    }
    .button:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    h2 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    .rule-list {
      list-style: none;
      padding: 0;
    }
    .rule-list li {
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 4px;
    }
    .missing-list li {
      background: rgba(255, 100, 100, 0.15);
      border-left: 3px solid rgba(255, 100, 100, 0.8);
    }
    .missing-list li a {
      color: var(--fg);
      text-decoration: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .missing-list li a:hover {
      text-decoration: underline;
    }
    .missing-list .arrow {
      opacity: 0.5;
    }
    .present-list li {
      background: rgba(100, 255, 100, 0.1);
      border-left: 3px solid rgba(100, 255, 100, 0.6);
      color: var(--fg);
    }
    .loading {
      opacity: 0.5;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="../index.html" class="back-link">← Back to Gallery</a>
    <h1>Thumbnail Status Checker</h1>
  </div>
  
  <div class="status">
    <div class="summary loading" id="summary">Checking thumbnails...</div>
    
    <button class="button" id="refresh">↻ Refresh Check</button>
    
    <h2>Missing Thumbnails (<span id="missing-count">0</span>)</h2>
    <p style="opacity: 0.8; margin-bottom: 1rem;">Click a rule to open it and create a thumbnail</p>
    <ul class="rule-list missing-list" id="missing-list"></ul>
    
    <h2>Present Thumbnails (<span id="present-count">0</span>)</h2>
    <ul class="rule-list present-list" id="present-list"></ul>
  </div>

  <script type="module">
    import { RULE_KEYS } from '../rules/index.js';

    async function checkThumbnail(ruleId) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        // Cache bust to avoid false positives
        img.src = `../thumbnails/${ruleId}.png?t=${Date.now()}`;
      });
    }

    async function checkAllThumbnails() {
      const missing = [];
      const present = [];

      const summaryEl = document.getElementById('summary');
      const missingList = document.getElementById('missing-list');
      const presentList = document.getElementById('present-list');
      
      summaryEl.className = 'summary loading';
      summaryEl.textContent = 'Checking thumbnails...';
      missingList.innerHTML = '';
      presentList.innerHTML = '';

      // Check each rule
      for (const ruleId of RULE_KEYS) {
        const exists = await checkThumbnail(ruleId);
        if (exists) {
          present.push(ruleId);
        } else {
          missing.push(ruleId);
        }
      }

      // Update summary
      summaryEl.className = 'summary';
      const percentComplete = Math.round((present.length / RULE_KEYS.length) * 100);
      summaryEl.innerHTML = `
        <div><strong>Total Rules:</strong> ${RULE_KEYS.length}</div>
        <div style="color: rgba(100, 255, 100, 0.9);"><strong>Present:</strong> ${present.length} (${percentComplete}%)</div>
        <div style="color: rgba(255, 100, 100, 0.9);"><strong>Missing:</strong> ${missing.length}</div>
      `;

      // Update counts
      document.getElementById('missing-count').textContent = missing.length;
      document.getElementById('present-count').textContent = present.length;

      // Update missing list
      if (missing.length === 0) {
        missingList.innerHTML = '<li style="border-color: rgba(100, 255, 100, 0.6); background: rgba(100, 255, 100, 0.15);">✓ All thumbnails present!</li>';
      } else {
        missing.forEach(id => {
          const li = document.createElement('li');
          const link = document.createElement('a');
          link.href = `../play.html?rule=${encodeURIComponent(id)}`;
          
          const text = document.createElement('span');
          text.textContent = id;
          
          const arrow = document.createElement('span');
          arrow.className = 'arrow';
          arrow.textContent = '→';
          
          link.appendChild(text);
          link.appendChild(arrow);
          li.appendChild(link);
          missingList.appendChild(li);
        });
      }

      // Update present list
      if (present.length === 0) {
        presentList.innerHTML = '<li style="opacity: 0.5;">No thumbnails yet</li>';
      } else {
        present.forEach(id => {
          const li = document.createElement('li');
          li.textContent = id;
          presentList.appendChild(li);
        });
      }
    }

    // Initial check
    checkAllThumbnails();

    // Refresh button
    document.getElementById('refresh').addEventListener('click', () => {
      checkAllThumbnails();
    });
  </script>
</body>
</html>
